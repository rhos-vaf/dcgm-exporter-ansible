---
- name: Check for installed nvidia-driver RPM
  ansible.builtin.package_facts:
    manager: rpm

- name: Check if nvidia-driver installation is needed
  ansible.builtin.set_fact:
    _install_nvidia_driver: "{{ 'nvidia-driver' not in ansible_facts.packages }}"

- name: Install nvidia-driver RPM if needed
  when: _install_nvidia_driver
  block:
  - name: Add EPEL repository for DKMS support
    ansible.builtin.yum_repository:
      name: epel
      description: EPEL YUM repo
      baseurl: https://download.fedoraproject.org/pub/epel/9/Everything/$basearch/
      enabled: 1
      gpgcheck: 1
      gpgkey: https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-9

  - name: Install nvidia-driver RPM module
    ansible.builtin.dnf:
      name: "@nvidia-driver:{{ dcgm_exporter_nvidia_driver_module_version }}"
      state: present
    notify: Restart dcgm-exporter

  - name: Refresh package facts after driver installation
    ansible.builtin.package_facts:
      manager: rpm
